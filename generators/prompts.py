"""
프롬프트 템플릿 모듈
5종 글 구조 템플릿과 AI 탐지 우회를 위한 인간 페르소나를 정의합니다.
"""
import random
from datetime import datetime

# =============================================================================
# AI 탐지 우회용 인간 페르소나 프롬프트
# =============================================================================

HUMAN_PERSONA_PROMPT = """당신은 30대 한국인 블로거입니다. 실제 경험을 바탕으로 친근하게 글을 씁니다.

[글쓰기 스타일]
- 구어체 사용 ("~해요", "~거든요", "~더라고요")
- 감탄사 자연스럽게 삽입 ("와", "대박", "솔직히", "진짜")
- 문장 길이 불규칙하게 (짧은 문장과 긴 문장 섞기)
- 개인 경험담 형식으로 작성
- 독자에게 말 걸듯이 ("여러분", "혹시", "그렇죠?")

[절대 금지]
- "첫째, 둘째, 셋째" 같은 딱딱한 나열
- "~하는 것이 중요합니다" 같은 교과서적 표현
- 모든 문장이 비슷한 길이로 정렬됨
- "제공해주신", "작성하겠습니다" 등 AI 메타 표현
- 너무 완벽하고 정제된 문장

[자연스러운 표현 예시]
- "이거 진짜 꿀팁인데요" ✓
- "솔직히 저도 처음엔 몰랐어요" ✓
- "근데 알고 보니까 완전 쉽더라고요" ✓
- "여러분도 한번 해보세요 ㅎㅎ" ✓
"""

# =============================================================================
# 시스템 프롬프트
# =============================================================================

SYSTEM_PROMPT = """당신은 전문 블로그 콘텐츠 작가입니다.
SEO에 최적화된 고품질 블로그 글을 HTML 형식으로 작성합니다.

[HTML 스타일 가이드]
- 전체를 <div style="max-width: 700px; margin: 0 auto; font-size: 16px; line-height: 1.9; color: #333;">로 감싸기
- 대제목: <h2 style="font-size: 26px; font-weight: 700; color: #222; margin-top: 40px;">
- 소제목: <h3 style="font-size: 20px; font-weight: 600; color: #333; margin-top: 30px;">
- 본문: <p style="font-size: 16px; line-height: 2.0; color: #444; margin: 20px 0;">
- 리스트: <ul style="padding-left: 20px;"><li style="margin: 10px 0;">
- 강조: <strong style="color: #222;">
- 표: <table style="width: 100%; border-collapse: collapse; margin: 25px 0;">

[이미지 태그 규칙]
- [IMAGE_1], [IMAGE_2], [IMAGE_3] 형식으로만 작성
- 콜론(:)이나 설명 추가 금지

결과는 순수 HTML만 출력하세요 (```html 코드 블록 없이).
"""

# =============================================================================
# 5종 글 구조 템플릿
# =============================================================================

TEMPLATES = {
    "problem_solution": {
        "name": "문제-해결형",
        "intro_pattern": "혹시 {keyword} 때문에 고민이신가요? 저도 예전에 똑같은 고민을 했었는데요.",
        "structure": [
            "서론: 문제 공감 및 경험담 (400자 이상)",
            "본론1: 문제의 원인 분석 (600자 이상)",
            "본론2: 해결 방법 5가지 상세 설명 (1000자 이상)",
            "본론3: 실전 팁과 주의사항 (600자 이상)",
            "본론4: 관련 최신 정보 (500자 이상)",
            "결론: 핵심 요약 및 응원 메시지 (400자 이상)",
        ],
        "min_words": 5000,
        "max_words": 6000,
    },
    "storytelling": {
        "name": "스토리텔링형",
        "intro_pattern": "저도 예전에 {keyword} 때문에 고생 좀 했어요. 오늘은 그 경험담을 공유해볼게요.",
        "structure": [
            "서론: 개인 경험담 시작 (400자 이상)",
            "본론1: 겪었던 어려움 상세 (700자 이상)",
            "본론2: 깨달음의 순간과 전환점 (600자 이상)",
            "본론3: 해결 과정과 노하우 (800자 이상)",
            "본론4: 현재 상황과 성과 (500자 이상)",
            "결론: 배운 점과 독자에게 조언 (400자 이상)",
        ],
        "min_words": 5000,
        "max_words": 6000,
    },
    "listicle": {
        "name": "리스트형",
        "intro_pattern": "오늘은 {keyword}에 대해 핵심만 쏙쏙 정리해볼게요!",
        "structure": [
            "서론: 주제 소개와 중요성 (400자 이상)",
            "본론: 7가지 핵심 포인트 (각 500자 이상, 총 3500자)",
            "보너스 팁: 추가 꿀팁 3가지 (400자 이상)",
            "정리 표: 항목별 비교표",
            "결론: 핵심 요약과 실천 방법 (400자 이상)",
        ],
        "min_words": 5000,
        "max_words": 6000,
    },
    "comparison": {
        "name": "비교분석형",
        "intro_pattern": "{keyword}, 뭐가 더 좋을까요? 오늘 확실하게 정리해드릴게요.",
        "structure": [
            "서론: 비교 주제 소개와 배경 (400자 이상)",
            "본론1: 기본 정보 상세 설명 (700자 이상)",
            "본론2: 장점 분석 (각 항목 상세) (800자 이상)",
            "본론3: 단점 분석 (각 항목 상세) (600자 이상)",
            "본론4: 실제 사용 후기/사례 (500자 이상)",
            "비교표: 항목별 상세 비교표",
            "결론: 상황별 추천과 최종 정리 (400자 이상)",
        ],
        "min_words": 5000,
        "max_words": 6000,
    },
    "qa_format": {
        "name": "Q&A형",
        "intro_pattern": "{keyword} 관련해서 많이들 궁금해하시더라고요. 자주 묻는 질문 정리해봤어요!",
        "structure": [
            "서론: 주제 소개 및 공감 (400자 이상)",
            "본론: Q&A 8개 (각 답변 400자 이상, 총 3200자)",
            "추가 정보: 알아두면 좋은 심화 내용 (600자 이상)",
            "결론: 핵심 정리와 마무리 (400자 이상)",
        ],
        "min_words": 5000,
        "max_words": 6000,
    },
}


def get_random_template() -> tuple:
    """
    랜덤 템플릿 선택

    Returns:
        (템플릿 키, 템플릿 정보) 튜플
    """
    template_key = random.choice(list(TEMPLATES.keys()))
    return template_key, TEMPLATES[template_key]


def generate_content_prompt(
    keyword: str,
    category: str,
    template_key: str,
    web_context: str = "",
    is_evergreen: bool = False
) -> str:
    """
    콘텐츠 생성 프롬프트 생성

    Args:
        keyword: 키워드
        category: 카테고리
        template_key: 템플릿 키
        web_context: 웹검색 컨텍스트
        is_evergreen: 에버그린 콘텐츠 여부

    Returns:
        프롬프트 문자열
    """
    template = TEMPLATES[template_key]
    current_year = datetime.now().year

    # 글자수 설정 (에버그린은 더 길게)
    if is_evergreen:
        min_words = 6000
        max_words = 7000
    else:
        min_words = template["min_words"]
        max_words = template["max_words"]

    # 서론 패턴
    intro = template["intro_pattern"].format(keyword=keyword)

    # 구조 설명
    structure = "\n".join(f"  {i+1}. {s}" for i, s in enumerate(template["structure"]))

    prompt = f"""당신은 10년차 전문 블로거입니다. '{keyword}'에 대한 상세하고 유익한 블로그 글을 작성합니다.

## 기본 정보
- 주제: '{keyword}'
- 카테고리: {category}
- 템플릿: {template['name']}
- **목표 글자수: 반드시 {min_words}~{max_words}자** (공백 포함, 이것은 필수입니다!)

## 서론 시작 문장
"{intro}"

## 글 구조 (각 섹션별 글자수를 반드시 지켜주세요)
{structure}

## 이미지 삽입 위치 (반드시 본문 중간에 삽입)
- [IMAGE_1]: 첫 번째 본론 섹션 뒤
- [IMAGE_2]: 중간 본론 섹션 뒤
- [IMAGE_3]: 마지막 본론 섹션 뒤

## 작성 규칙
1. 반드시 {current_year}년 기준 최신 정보로 작성
2. 구어체로 친근하게 작성 (~해요, ~거든요, ~더라고요)
3. '{keyword}'를 본문에 자연스럽게 10회 이상 포함
4. 각 섹션에 구체적인 숫자, 날짜, 이름, 예시 포함
5. 이미지 태그는 [IMAGE_1], [IMAGE_2], [IMAGE_3] 형식만 사용
6. HTML 형식으로 출력

## 절대 금지
- "첫째, 둘째" 같은 딱딱한 표현
- "~하는 것이 중요합니다" 교과서적 표현
- 추상적이고 일반적인 내용만 나열
- 글자수 5000자 미만으로 작성
"""

    # 웹검색 컨텍스트 추가 (핵심!)
    if web_context:
        prompt += f"""
## 웹검색 결과 (반드시 이 정보를 본문에 반영하세요!)
{web_context[:4000]}

### 중요: 위 검색 결과에서 다음을 반드시 추출하여 본문에 포함하세요:
- 구체적인 숫자/통계
- 날짜와 시기 정보
- 인물명, 기관명, 제품명
- 최신 뉴스나 이슈 내용
- 전문가 의견이나 인용구

검색 결과의 실제 정보를 바탕으로 사실에 기반한 글을 작성하세요.
개인 경험담 형식이지만, 검색 결과의 사실 정보를 녹여내야 합니다.
"""
    else:
        prompt += f"""
## 주의
웹검색 결과가 없으므로, '{keyword}'에 대한 일반적인 정보를 상세하게 작성하세요.
구체적인 예시와 설명을 충분히 포함하여 {min_words}자 이상 작성하세요.
"""

    prompt += """
## 필수 태그
- [COUPANG]: 쿠팡 상품 위치 (본문 중간 또는 하단)
- [META]SEO 메타 설명 150자 이내[/META]: 글 맨 끝

## 최종 확인사항
- [ ] 글자수가 5000자 이상인가?
- [ ] [IMAGE_1], [IMAGE_2], [IMAGE_3]이 본문 중간에 배치되었는가?
- [ ] 웹검색 결과의 구체적 정보가 반영되었는가?
- [ ] 키워드가 10회 이상 자연스럽게 포함되었는가?

결과는 순수 HTML만 출력하세요 (```html 없이).
"""

    return prompt


def generate_title_prompt(keyword: str) -> str:
    """
    제목 생성 프롬프트

    Args:
        keyword: 키워드

    Returns:
        프롬프트 문자열
    """
    current_year = datetime.now().year

    return f"""
다음 키워드로 블로그 제목을 1개만 생성하세요.

키워드: {keyword}

[제목 규칙]
1. {current_year}년 또는 최신 연도 포함 (해당되는 경우)
2. 클릭을 유도하는 매력적인 제목
3. 숫자 활용 권장 ("5가지", "TOP 7" 등)
4. 30~50자 사이
5. 이모지 사용하지 않음

[제목 스타일 예시]
- "2025 연말정산 환급 받는 5가지 꿀팁"
- "비트코인 전망, 전문가가 알려주는 핵심 포인트"
- "아이폰16 vs 갤럭시S25 완벽 비교 총정리"

제목만 출력하세요 (따옴표 없이):
"""


# =============================================================================
# 마무리 패턴
# =============================================================================

OUTRO_PATTERNS = [
    "오늘 {keyword}에 대해 정리해봤는데요, 도움이 되셨으면 좋겠어요!",
    "여기까지 {keyword} 관련 내용이었어요. 궁금한 거 있으면 댓글로!",
    "{keyword}, 이제 좀 감이 오시나요? 화이팅!",
    "오늘 내용이 도움이 됐다면 공유 부탁드려요~",
]


def get_outro_pattern(keyword: str) -> str:
    """마무리 패턴 랜덤 선택"""
    pattern = random.choice(OUTRO_PATTERNS)
    return pattern.format(keyword=keyword)
